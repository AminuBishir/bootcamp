{% extends "base.html" %}

{% block css %}
<style>
    .messages-container{
        max-height: 100px;
        overflow-y: auto;
        width: 500px;
        border: 1px solid blue;
    }
</style>
{% endblock css %}

{% block content %}
    <h1>Messages</h1>
    {% for user in current_user.followed %}
        <a href="{{ url_for('chat.chat', username=user.username) }}">{{ user.username }}</a><br>
    {% endfor %}
    {% if recipient is not none %}
        <div id="messages" class="messages-container"></div>
        <input type="text" id="messagebox"/>
        <button onclick="sendMessage()">Send</button>
    {% endif %}
{% endblock content %}

{% block js_scripts %}
    {% if recipient %}
    <script>
        let channelID = null;
        let channelName = null;
        let currentChatChannel = null;
        let senderChatChannel = null;
        let recipientChatChannel = null;
        let senderID = {{ current_user.id }}
        let recipientID = {{ recipient.id }}

        let pusher = new Pusher('04587cc4f2fd0ca4213c', {
                cluster: 'ap2',
                forceTLS: true,
                authEndpoint: "/chat/pusher/auth"
            });
        
        $(function(){
            const personalChannel = pusher.subscribe(`private-chat_user_${senderID}`)
            personalChannel.bind("new_chat", function(data){
                const isSubscribed = pusher.channel(data.channel_name)
                if(!isSubscribed){
                    let one_on_one_chat = subscribeChatChannel(data.channel_name)
                }
            })

            $( "input#messagebox" ).keydown(function( event ) {
                if ( event.which == 13 ) {
                    sendMessage();
                }
            });

            (function requestChat(){
                $.ajax({
                    url: "/chat/request_chat",
                    method: "POST",
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        recipient_id: recipientID,
                    })
                }).done(function(data){
                    channelID = data.channel_id
                    channelName = data.channel_name;
                    currentChatChannel = data.channel_name;
                    senderChatChannel = data.sender_chat_channel;
                    recipientChatChannel = data.recipient_chat_channel

                    getMessagesInChannle();
                    const isSubscribed = pusher.channel(data.channel_name)
                    if(!isSubscribed){
                        let one_on_one_chat = subscribeChatChannel(data.channel_name)
                    }
                })
            })();
    
        })

        function getMessagesInChannle(){
            $.ajax({
                url: `/chat/get_message/${channelID}`,
                method: 'GET',
                dataType: 'json',
                contentType: 'application/json',
            }).done(function(data){
                data.forEach(function(messageObj){
                    $('#messages').append(`<p>${messageObj.message}</p>`)
                })
                scrollToBottom();
            })
        }


        function subscribeChatChannel(channelName) {
            var channel = pusher.subscribe(channelName);
            channel.bind('new_message', function (data) {
                if(data.channel_name === currentChatChannel){
                    $('#messages').append(`<p>${data.message}</p>`);
                    scrollToBottom();
                }
            });
            return channel
        }

        function sendMessage(event){
            let message = $('input#messagebox').val()
            $.ajax({
                url: '/chat/send_message',
                method: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify({
                    channel : channelID,
                    message : message,
                    sender_id: {{ current_user.id }},
                    recipient_id : {{ recipient.id }},
                })
            }).done(function(data){
                $('input#messagebox').val("")
                scrollToBottom();
            })
        }

        function scrollToBottom() {
            $('#messages').animate({scrollTop: $('#messages').prop('scrollHeight')});
        };

    </script>
    {% endif %}
{% endblock js_scripts %}